#!/bin/bash

GUI_USER=$(who | grep console | grep -v '_mbsetupuser' | awk '{print $1}') 

#get Zoom Webserver PID
ZoomOpenerPID=$(lsof -ti :19421)

#kill it with fire
if [[ -n "$ZoomOpenerPID" ]]; then
  kill -9 "$ZoomOpenerPID"
fi
pkill "RingCentralOpener"

for USER_HOME in /Users/*; do
  USER_UID=$(basename "${USER_HOME}")
  if [[ -d "${USER_HOME}"/.zoomus/ZoomOpener.app ]]; then
    echo "Patching zoom for User $USER_UID..."
    
    # remove .zoomus folder and create a dummy file in its place
    rm -r "${USER_HOME}"/.zoomus
    touch "${USER_HOME}"/.zoomus
    chmod 000 "${USER_HOME}"/.zoomus

    # Ringcentral (whiteboxed zoom software)
    rm -r "${USER_HOME}"/.ringcentralopener
    touch "${USER_HOME}"/.ringcentralopener
    chmod 000 "${USER_HOME}"/.ringcentralopener

    # Zoom Preferences for video
    rm "${USER_HOME}"/Library/Preferences/us.zoom.config.plist ||true
    rm /Library/Preferences/us.zoom.config.plist || true
  fi
done

# defaults write /Users/$GUI_USER/Library/Preferences/us.zoom.config.plist ZDisableVideo 1

# defaults write /Library/Preferences/us.zoom.config.plist ZDisableVideo 1
